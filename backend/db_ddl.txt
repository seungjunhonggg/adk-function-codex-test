-- PostgreSQL DDL for column metadata catalog
-- This schema stores display labels, descriptions, units, and grouping rules
-- so agents can map natural language requests to DB columns consistently.

CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Table registry (which physical table a column belongs to)
CREATE TABLE table_catalog (
  table_key      TEXT PRIMARY KEY,           -- Internal key, e.g. mdh_base_view_total
  schema_name    TEXT NOT NULL,              -- DB schema name
  table_name     TEXT NOT NULL,              -- Physical table/view name
  date_column    TEXT,                       -- Column used for recent N-month filters
  join_keys      TEXT[] DEFAULT '{}',        -- Join keys, e.g. lot_id, chip_prod_id
  description_ko TEXT,                       -- Human-readable table description
  is_active      BOOLEAN DEFAULT TRUE,       -- Soft enable/disable
  created_at     TIMESTAMPTZ DEFAULT now(),
  updated_at     TIMESTAMPTZ DEFAULT now()
);

-- Column master catalog (the single source of truth for column metadata)
CREATE TABLE column_catalog (
  column_id          BIGSERIAL PRIMARY KEY,
  table_key          TEXT NOT NULL REFERENCES table_catalog(table_key), -- Parent table
  column_name        TEXT NOT NULL,          -- Physical column name
  display_ko         TEXT NOT NULL,          -- Korean label shown to users
  description_ko     TEXT,                   -- Korean description for briefing
  data_type          TEXT,                   -- number/text/date/etc
  unit               TEXT,                   -- V, uF, ppm, %
  value_unit         TEXT CHECK (value_unit IN ('percent','ppm','ratio','count','none') OR value_unit IS NULL),
  process_stage      TEXT,                   -- firing/measurement/grinding/etc
  metric_type        TEXT,                   -- defect/param/result/etc
  is_chartable       BOOLEAN DEFAULT FALSE,  -- Whether to render as chart by default
  default_agg        TEXT,                   -- avg/max/min/sum/etc
  default_chart_type TEXT,                   -- bar/line/table/etc
  is_active          BOOLEAN DEFAULT TRUE,   -- Soft enable/disable
  created_at         TIMESTAMPTZ DEFAULT now(),
  updated_at         TIMESTAMPTZ DEFAULT now(),
  UNIQUE (table_key, column_name)
);

-- Alias table for natural language mapping (synonyms/abbrev/typos)
CREATE TABLE column_alias (
  alias_id   BIGSERIAL PRIMARY KEY,
  column_id  BIGINT NOT NULL REFERENCES column_catalog(column_id) ON DELETE CASCADE,
  alias      TEXT NOT NULL,                  -- User phrase or shorthand
  lang       TEXT DEFAULT 'ko',
  match_type TEXT DEFAULT 'synonym',         -- synonym/abbr/typo
  score      NUMERIC(4,3) DEFAULT 1.0,       -- Relative priority
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE (alias, lang)
);

-- Chart/briefing group definitions
CREATE TABLE column_group (
  group_key      TEXT PRIMARY KEY,           -- e.g. inspection_defect_rate_ppm
  label_ko       TEXT NOT NULL,              -- Group display name
  group_type     TEXT,                       -- process/inspection/defect/etc
  unit           TEXT,                       -- ppm/percent/ratio
  description_ko TEXT,                       -- When to use this group
  is_active      BOOLEAN DEFAULT TRUE,
  created_at     TIMESTAMPTZ DEFAULT now()
);

-- Group members (which columns are included in each group)
CREATE TABLE column_group_member (
  group_key  TEXT NOT NULL REFERENCES column_group(group_key) ON DELETE CASCADE,
  column_id  BIGINT NOT NULL REFERENCES column_catalog(column_id) ON DELETE CASCADE,
  sort_order INT DEFAULT 0,                  -- Display order in charts/tables
  role       TEXT DEFAULT 'main',            -- main/sub
  PRIMARY KEY (group_key, column_id)
);

-- Parameter normalization (user value -> DB value)
CREATE TABLE param_value_map (
  map_id     BIGSERIAL PRIMARY KEY,
  param_key  TEXT NOT NULL,                  -- temperature/size/capacity/etc
  user_value TEXT NOT NULL,                  -- User input
  db_value   TEXT NOT NULL,                  -- Actual DB value
  unit       TEXT,                           -- Optional unit
  note       TEXT,                           -- Freeform note
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE (param_key, user_value)
);

-- Indexes for fast lookup
CREATE INDEX idx_column_catalog_name ON column_catalog(table_key, column_name);
CREATE INDEX idx_column_catalog_stage ON column_catalog(process_stage, metric_type);
CREATE INDEX idx_column_catalog_chartable ON column_catalog(is_chartable);

CREATE INDEX idx_alias_trgm ON column_alias USING gin (alias gin_trgm_ops);
CREATE INDEX idx_display_ko_trgm ON column_catalog USING gin (display_ko gin_trgm_ops);
CREATE INDEX idx_desc_ko_trgm ON column_catalog USING gin (description_ko gin_trgm_ops);

-- Suggested indexes for mdh_base_view_total (lot_search + grid match)
-- Review with EXPLAIN ANALYZE before production use.
CREATE INDEX idx_mdh_base_lot_id ON mdh_base_view_total (lot_id);
CREATE INDEX idx_mdh_base_chip_prod_id ON mdh_base_view_total (chip_prod_id);
CREATE INDEX idx_mdh_base_chip_prod_id_trgm
  ON mdh_base_view_total USING gin (chip_prod_id gin_trgm_ops);

-- Param filters used for chip_prod selection
CREATE INDEX idx_mdh_base_param_filters
  ON mdh_base_view_total (temperature, voltage, size, capacity, lot_type);

-- Recent-date filter in lot_search/grid matching
CREATE INDEX idx_mdh_base_design_input_date_brin
  ON mdh_base_view_total USING brin (design_input_date);

-- Grid match filters (ref lot -> post-grid search)
CREATE INDEX idx_mdh_base_grid_match
  ON mdh_base_view_total (
    active_powder_base,
    active_powder_additives,
    ldn_avr_value,
    cast_dsgn_thk,
    design_input_date
  );

-- Optional: pre-filter for "OK/0" defect conditions
CREATE INDEX idx_mdh_base_defect_ok
  ON mdh_base_view_total (
    cutting_defect,
    measure_defect,
    x_fr_ispass,
    contact_defect,
    pass_halt,
    pass_8585,
    pass_burn_in,
    x_df_ispass,
    x_odb_pass_yn
  )
  WHERE x_fr_ispass = 'OK'
    AND contact_defect = 0
    AND pass_halt = 'OK'
    AND pass_8585 = 'OK'
    AND pass_burn_in = 'OK'
    AND x_df_ispass = 'OK'
    AND x_odb_pass_yn = 'OK';

-- Optional: if NULLs are very frequent, consider partial indexes on required columns
-- Example:
-- CREATE INDEX idx_mdh_base_required_not_null
--   ON mdh_base_view_total (grinding_l_avg, grinding_t_avg, grinding_w_avg, electrode_c_avg)
--   WHERE grinding_l_avg IS NOT NULL
--     AND grinding_t_avg IS NOT NULL
--     AND grinding_w_avg IS NOT NULL
--     AND electrode_c_avg IS NOT NULL;

-- Sample seed data for metadata tables (safe to re-run with ON CONFLICT)
-- Note: display_ko/description_ko fields are in English here to keep this file ASCII-only.

INSERT INTO table_catalog (
  table_key, schema_name, table_name, date_column, join_keys, description_ko, is_active
) VALUES (
  'mdh_base_view_total',
  'public',
  'mdh_base_view_total',
  'design_input_date',
  ARRAY['lot_id', 'chip_prod_id'],
  'Main lot search view',
  TRUE
) ON CONFLICT (table_key) DO NOTHING;

INSERT INTO column_catalog (
  table_key,
  column_name,
  display_ko,
  description_ko,
  data_type,
  unit,
  value_unit,
  process_stage,
  metric_type,
  is_chartable,
  default_agg,
  default_chart_type
) VALUES
  ('mdh_base_view_total', 'lot_id', 'LOT ID', 'Lot identifier', 'text', NULL, NULL, 'identity', 'id', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'chip_prod_id', 'Chip Product ID', 'Chip product identifier', 'text', NULL, NULL, 'identity', 'id', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'temperature', 'Temperature', 'Dielectric spec', 'text', NULL, NULL, 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'voltage', 'Voltage', 'Rated voltage', 'numeric', 'V', 'none', 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'size', 'Size', 'Case size', 'text', NULL, NULL, 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'capacity', 'Capacity', 'Capacitance', 'numeric', 'uF', 'none', 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'design_input_date', 'Design Input Date', 'Design input date', 'date', NULL, NULL, 'meta', 'date', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'ci_def_rate', 'Cutting Defect Rate', 'Cutting defect rate', 'numeric', '%', 'percent', 'cutting', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_defect_rate', 'Firing Defect Rate', 'Firing defect rate', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'sum_burn_ppm', 'Burn-In PPM', 'Burn-in reliability ppm', 'numeric', 'ppm', 'ppm', 'reliability', 'defect', TRUE, 'avg', 'bar')
ON CONFLICT (table_key, column_name) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, 'temp', 'ko', 'abbr', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'temperature'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, 'cap', 'ko', 'abbr', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'capacity'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, 'cut_def_rate', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'ci_def_rate'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_group (
  group_key, label_ko, group_type, unit, description_ko, is_active
) VALUES
  ('process_defect_rate', 'Process Defect Rate', 'process', 'percent', 'Process defect rate chart', TRUE),
  ('inspection_defect_rate_ppm', 'Inspection Defect Rate (PPM)', 'inspection', 'ppm', 'Inspection defect rate chart (ppm)', TRUE)
ON CONFLICT (group_key) DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'process_defect_rate', column_id, 1, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'ci_def_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_ppm', column_id, 1, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'fr_defect_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_ppm', column_id, 2, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'sum_burn_ppm'
ON CONFLICT DO NOTHING;

INSERT INTO param_value_map (param_key, user_value, db_value, unit, note)
VALUES
  ('temperature', 'X5R', 'X5R', NULL, 'Dielectric grade'),
  ('size', '0603', '0603', NULL, 'Case size'),
  ('capacity', '1.8uF', '1.8', 'uF', 'Capacitance'),
  ('voltage', '6.3V', '6.3', 'V', 'Rated voltage')
ON CONFLICT (param_key, user_value) DO NOTHING;

-- Expanded seed data (Korean labels + defect metrics)
-- Uses U&'' Unicode escapes so this file stays ASCII-only.

UPDATE table_catalog
SET description_ko = U&'\AE30\BCF8 LOT \C870\D68C \BDD0'
WHERE table_key = 'mdh_base_view_total';

INSERT INTO column_group (
  group_key, label_ko, group_type, unit, description_ko, is_active
) VALUES
  ('process_defect_rate', U&'\ACF5\C815 \BD88\B7C9\B960', 'process', 'percent', U&'\ACF5\C815 \B2E8\ACC4 \BD88\B7C9\B960 \CC28\D2B8', TRUE),
  ('inspection_defect_rate_ppm', U&'\AC80\C0AC \BD88\B7C9\B960 (PPM)', 'inspection', 'ppm', U&'\AC80\C0AC \BD88\B7C9\B960 \CC28\D2B8 (PPM)', TRUE),
  ('inspection_defect_rate_percent', U&'\AC80\C0AC \BD88\B7C9\B960 (%)', 'inspection', 'percent', U&'\AC80\C0AC \BD88\B7C9\B960 \CC28\D2B8 (%)', TRUE)
ON CONFLICT (group_key) DO UPDATE SET
  label_ko = EXCLUDED.label_ko,
  group_type = EXCLUDED.group_type,
  unit = EXCLUDED.unit,
  description_ko = EXCLUDED.description_ko,
  is_active = EXCLUDED.is_active;

INSERT INTO column_catalog (
  table_key, column_name, display_ko, description_ko, data_type, unit, value_unit, process_stage, metric_type, is_chartable, default_agg, default_chart_type
) VALUES
  ('mdh_base_view_total', 'lot_id', U&'\B85C\D2B8 ID', U&'\B85C\D2B8 \C2DD\BCC4\C790', 'text', NULL, NULL, 'identity', 'id', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'chip_prod_id', U&'\CE69 \C81C\D488 ID', U&'\CE69 \C81C\D488 \C2DD\BCC4\C790', 'text', NULL, NULL, 'identity', 'id', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'temperature', U&'\C628\B3C4 \D2B9\C131', U&'\C720\C804 \D2B9\C131 \B4F1\AE09', 'text', NULL, NULL, 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'voltage', U&'\C804\C555', U&'\C815\ACA9 \C804\C555', 'numeric', 'V', 'none', 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'size', U&'\C0AC\C774\C988', U&'\CE69 \C0AC\C774\C988', 'text', NULL, NULL, 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'capacity', U&'\C6A9\B7C9', U&'\C815\C804\C6A9\B7C9', 'numeric', 'uF', 'none', 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'lot_type', U&'\C0DD\C0B0\BAA8\B4DC', U&'\C591\C0B0/\C2DC\C0DD\C0B0 \B4F1 \C0DD\C0B0\BAA8\B4DC', 'text', NULL, NULL, 'spec', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'design_input_date', U&'\C124\ACC4 \C785\B825\C77C', U&'\C124\ACC4 \C785\B825 \B0A0\C9DC', 'date', NULL, NULL, 'meta', 'date', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'active_powder_base', U&'\BAA8\C7AC', U&'\D65C\C131\BD84\B9D0 \BAA8\C7AC', 'text', NULL, NULL, 'design', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'active_powder_additives', U&'\CCA8\AC00\C81C', U&'\D65C\C131\BD84\B9D0 \CCA8\AC00\C81C', 'text', NULL, NULL, 'design', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'ldn_avr_value', U&'LDN \D3C9\ADE0\AC12', U&'LayDown \D3C9\ADE0\AC12', 'numeric', NULL, 'none', 'design', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'cast_dsgn_thk', U&'\CE90\C2A4\D2B8 \C124\ACC4 \B450\AED8', U&'\CE90\C2A4\D2B8 \C124\ACC4 \B450\AED8', 'numeric', NULL, 'none', 'design', 'param', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'cutting_defect', U&'\C808\B2E8\C131 \BD88\B7C9 \B4F1\AE09', U&'\C808\B2E8\C131 \BD88\B7C9 \B4F1\AE09', 'text', NULL, NULL, 'cutting', 'grade', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'measure_defect', U&'\CE21\C815 \BD88\B7C9 \B4F1\AE09', U&'\CE21\C815 \BD88\B7C9 \B4F1\AE09', 'text', NULL, NULL, 'measurement', 'grade', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'x_fr_ispass', U&'\C18C\C131\AC80\C0AC \D1B5\ACFC\C5EC\BD80', U&'\C18C\C131\AC80\C0AC \D1B5\ACFC\C5EC\BD80', 'text', NULL, NULL, 'firing', 'flag', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'contact_defect', U&'\C811\CD09\C131 \BD88\B7C9', U&'\C811\CD09\C131 \BD88\B7C9', 'numeric', NULL, NULL, 'inspection', 'defect', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'pass_halt', U&'HALT \D1B5\ACFC\C5EC\BD80', U&'HALT \D1B5\ACFC\C5EC\BD80', 'text', NULL, NULL, 'reliability', 'flag', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'pass_8585', U&'8585 \D1B5\ACFC\C5EC\BD80', U&'8585 \D1B5\ACFC\C5EC\BD80', 'text', NULL, NULL, 'reliability', 'flag', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'pass_burn_in', U&'Burn-in \D1B5\ACFC\C5EC\BD80', U&'Burn-in \D1B5\ACFC\C5EC\BD80', 'text', NULL, NULL, 'reliability', 'flag', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'x_df_ispass', U&'\CE21\C815 \D1B5\ACFC\C5EC\BD80', U&'\CE21\C815 \D1B5\ACFC\C5EC\BD80', 'text', NULL, NULL, 'measurement', 'flag', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'x_odb_pass_yn', U&'ODB \D1B5\ACFC\C5EC\BD80', U&'ODB \D1B5\ACFC\C5EC\BD80', 'text', NULL, NULL, 'inspection', 'flag', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'bdv_avg', U&'BDV \D3C9\ADE0', U&'BDV \D3C9\ADE0\AC12', 'numeric', 'V', 'none', 'reliability', 'result', FALSE, NULL, NULL),
  ('mdh_base_view_total', 'ci_def_rate', U&'\C808\B2E8\CE69 \BD88\B7C9\B960', U&'\C808\B2E8\CE69 \BD88\B7C9\B960', 'numeric', '%', 'percent', 'cutting', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'ci_def_01', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 01', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 01', 'numeric', '%', 'percent', 'cutting', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'ci_def_02', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 02', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 02', 'numeric', '%', 'percent', 'cutting', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'ci_def_03', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 03', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 03', 'numeric', '%', 'percent', 'cutting', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'ci_def_04', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 04', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 04', 'numeric', '%', 'percent', 'cutting', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'ci_def_05', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 05', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 05', 'numeric', '%', 'percent', 'cutting', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'ci_def_99', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 99', U&'\C808\B2E8\CE69 \D558\C704\BD88\B7C9 99', 'numeric', '%', 'percent', 'cutting', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_defect_rate', U&'\C18C\C131\CE69 \BD88\B7C9\B960', U&'\C18C\C131\CE69 \BD88\B7C9\B960', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_01', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 01', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 01', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_02', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 02', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 02', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_03', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 03', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 03', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_04', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 04', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 04', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_04_1', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 04-1', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 04-1', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_05', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 05', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 05', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_06', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 06', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 06', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_07', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 07', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 07', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_08', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 08', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 08', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_09', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 09', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 09', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_10', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 10', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 10', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_11', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 11', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 11', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fr_def_99', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 99', U&'\C18C\C131\CE69 \D558\C704\BD88\B7C9 99', 'numeric', 'ppm', 'ppm', 'firing', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'gr_short_defect_rate', U&'\C5F0\B9C8\CE69 \BD88\B7C9\B960', U&'\C5F0\B9C8\CE69 \BD88\B7C9\B960', 'numeric', '%', 'percent', 'grinding', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'tvi_defect_rate_f', U&'\C5F0\B9C8\C678\AD00 \BD88\B7C9\B960', U&'\C5F0\B9C8\C678\AD00 \BD88\B7C9\B960', 'numeric', '%', 'percent', 'grinding', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'tr_short_defect_rate', U&'\C804\ADF9\CE69 \BD88\B7C9\B960', U&'\C804\ADF9\CE69 \BD88\B7C9\B960', 'numeric', '%', 'percent', 'electrode', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'df_def_rate', U&'\CE21\C815 \BD88\B7C9\B960', U&'\CE21\C815 \BD88\B7C9\B960', 'numeric', '%', 'percent', 'measurement', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'dr_def_01', U&'\CE21\C815 \D558\C704\BD88\B7C9 01', U&'\CE21\C815 \D558\C704\BD88\B7C9 01', 'numeric', '%', 'percent', 'measurement', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'dr_def_02', U&'\CE21\C815 \D558\C704\BD88\B7C9 02', U&'\CE21\C815 \D558\C704\BD88\B7C9 02', 'numeric', '%', 'percent', 'measurement', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'dr_def_03', U&'\CE21\C815 \D558\C704\BD88\B7C9 03', U&'\CE21\C815 \D558\C704\BD88\B7C9 03', 'numeric', '%', 'percent', 'measurement', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'soul_defect_rate_f', U&'\CE21\C815 \CD08\C74C\D30C \BD88\B7C9\B960', U&'\CE21\C815 \CD08\C74C\D30C \BD88\B7C9\B960', 'numeric', '%', 'percent', 'measurement', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'gm_defect_rate_f', U&'\CE21\C815 \C591\D488\BAB0\B4DC \BD88\B7C9\B960', U&'\CE21\C815 \C591\D488\BAB0\B4DC \BD88\B7C9\B960', 'numeric', '%', 'percent', 'measurement', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'pi_def_rate', U&'\C678\AD00 \BD88\B7C9\B960', U&'\C678\AD00 \BD88\B7C9\B960', 'numeric', '%', 'percent', 'appearance', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'pi_def_01', U&'\C678\AD00 \D558\C704\BD88\B7C9 01', U&'\C678\AD00 \D558\C704\BD88\B7C9 01', 'numeric', '%', 'percent', 'appearance', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'pi_def_02', U&'\C678\AD00 \D558\C704\BD88\B7C9 02', U&'\C678\AD00 \D558\C704\BD88\B7C9 02', 'numeric', '%', 'percent', 'appearance', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'pi_def_03', U&'\C678\AD00 \D558\C704\BD88\B7C9 03', U&'\C678\AD00 \D558\C704\BD88\B7C9 03', 'numeric', '%', 'percent', 'appearance', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'pi_def_04', U&'\C678\AD00 \D558\C704\BD88\B7C9 04', U&'\C678\AD00 \D558\C704\BD88\B7C9 04', 'numeric', '%', 'percent', 'appearance', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'pi_def_99', U&'\C678\AD00 \D558\C704\BD88\B7C9 99', U&'\C678\AD00 \D558\C704\BD88\B7C9 99', 'numeric', '%', 'percent', 'appearance', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'mf_def_rate', U&'MF \BD88\B7C9\B960', U&'MF \BD88\B7C9\B960', 'numeric', '%', 'percent', 'mf', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'ttm_defect_rate_f', U&'\C804\ADF9\BCF8\C5F0\B9C8\C678\AD00 \BD88\B7C9\B960', U&'\C804\ADF9\BCF8\C5F0\B9C8\C678\AD00 \BD88\B7C9\B960', 'numeric', '%', 'percent', 'electrode', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'sum_burn_ppm', U&'Burn-in \BD88\B7C9 ppm', U&'Burn-in \BD88\B7C9 ppm', 'numeric', 'ppm', 'ppm', 'reliability', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'sum_8585_ppm', U&'8585 \BD88\B7C9 ppm', U&'8585 \BD88\B7C9 ppm', 'numeric', 'ppm', 'ppm', 'reliability', 'defect', TRUE, 'avg', 'bar'),
  ('mdh_base_view_total', 'fail_halt_ppm', U&'HALT \BD88\B7C9 ppm', U&'HALT \BD88\B7C9 ppm', 'numeric', 'ppm', 'ppm', 'reliability', 'defect', TRUE, 'avg', 'bar')
ON CONFLICT (table_key, column_name) DO UPDATE SET
  display_ko = EXCLUDED.display_ko,
  description_ko = EXCLUDED.description_ko,
  data_type = EXCLUDED.data_type,
  unit = EXCLUDED.unit,
  value_unit = EXCLUDED.value_unit,
  process_stage = EXCLUDED.process_stage,
  metric_type = EXCLUDED.metric_type,
  is_chartable = EXCLUDED.is_chartable,
  default_agg = EXCLUDED.default_agg,
  default_chart_type = EXCLUDED.default_chart_type;

-- Group members for defect charts
INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'process_defect_rate', column_id, 1, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'ci_def_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'process_defect_rate', column_id, 2, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'tvi_defect_rate_f'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'process_defect_rate', column_id, 3, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'df_def_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'process_defect_rate', column_id, 4, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'pi_def_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'process_defect_rate', column_id, 5, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'mf_def_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'process_defect_rate', column_id, 6, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'ttm_defect_rate_f'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_ppm', column_id, 1, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'fr_defect_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_ppm', column_id, 2, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'sum_burn_ppm'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_ppm', column_id, 3, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'sum_8585_ppm'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_ppm', column_id, 4, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'fail_halt_ppm'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_percent', column_id, 1, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'gr_short_defect_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_percent', column_id, 2, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'tr_short_defect_rate'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_percent', column_id, 3, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'soul_defect_rate_f'
ON CONFLICT DO NOTHING;

INSERT INTO column_group_member (group_key, column_id, sort_order, role)
SELECT 'inspection_defect_rate_percent', column_id, 4, 'main'
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'gm_defect_rate_f'
ON CONFLICT DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, U&'\C808\B2E8\CE69\BD88\B7C9', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'ci_def_rate'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, U&'\C18C\C131\CE69\BD88\B7C9', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'fr_defect_rate'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, U&'\C5F0\B9C8\CE69\BD88\B7C9', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'gr_short_defect_rate'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, U&'\C804\ADF9\CE69\BD88\B7C9', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'tr_short_defect_rate'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, U&'\CE21\C815\BD88\B7C9', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'df_def_rate'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, U&'\C678\AD00\BD88\B7C9', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'pi_def_rate'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, U&'MF\BD88\B7C9', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'mf_def_rate'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, U&'\BC88\C778', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'sum_burn_ppm'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO column_alias (column_id, alias, lang, match_type, score)
SELECT column_id, 'HALT', 'ko', 'synonym', 1.0
FROM column_catalog
WHERE table_key = 'mdh_base_view_total' AND column_name = 'fail_halt_ppm'
ON CONFLICT (alias, lang) DO NOTHING;

INSERT INTO param_value_map (param_key, user_value, db_value, unit, note)
VALUES
  ('temperature', 'X5R', 'X5R', NULL, U&'\C720\C804 \D2B9\C131 \B4F1\AE09'),
  ('size', '0603', '0603', NULL, U&'\CE69 \C0AC\C774\C988'),
  ('capacity', '1.8uF', '1.8', 'uF', U&'\C815\C804\C6A9\B7C9'),
  ('voltage', '6.3V', '6.3', 'V', U&'\C815\ACA9 \C804\C555')
ON CONFLICT (param_key, user_value) DO UPDATE SET
  db_value = EXCLUDED.db_value,
  unit = EXCLUDED.unit,
  note = EXCLUDED.note;
